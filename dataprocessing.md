# Data Processing Implementation
## Initial Planning
### Process
- Create an image repository in GitHub.
- When there are changes in the Image Repository, only the modified files will be uploaded to the S3 Bucket, handled through GitHub Action.
- Upon an upload event to the S3 Bucket, the files will be stored under the `images/` prefix.
- Raw images will be stored in the `raw` directory.
- When stored, an event trigger will occur.
- The event trigger will execute a Lambda function, and the Lambda function will generate three additional resolution-specific files, which will then be uploaded to the S3 Bucket and recorded in DynamoDB.
- The resolution-specific files will be stored in the `sg`, `md`, and `lg` directories with the same filename.
- Uploaded files will have a unique filename in the format `YYMMDDHHMISS-8digit`, where the 8-digit value is a hash generated by a hash function.

### Github Action
- Executed when a Push event occurs on the main branch.
- Prevents Push for non-image files by adding an event trigger.
- If no issues are detected, the action executes a command to upload only the modified files to the S3 Bucket.
- Example code
```
name: Restrict Non-Image Files on Push

on:
  push:
    branches:
      - main

jobs:
  check-files:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Check if only image files were pushed
      run: |
        # Define the file extensions considered as images
        IMAGE_FILES=$(git diff --name-only HEAD^ HEAD | grep -E '\.(png|jpg|jpeg|gif|bmp|svg)$')

        # If there are no image files, fail the job
        if [ -z "$IMAGE_FILES" ]; then
          echo "No image files were pushed. Failing the job."
          exit 1
        fi

    - name: Success Message
      run: echo "Only image files were pushed, proceeding with the workflow."
```

### DynamoDB
- As it is NoSQL, no predefined schema is required. The following defines the key values
- `ImageId`: Managed as the primary key in the format `{S3Filename}_{FileType}`.
- `RegisteredFile`: The location and filename as registered in the GitHub repository.
- `UploadDate`: Date of registration.
- `StoredKey`: Key where the file is stored in the S3 Bucket.
- `ImageType`: One of `raw/sg/md/lg`.
- `ImageSize`: The size of the image.
- `Resolution`: The image resolution.
- `Status`: One of `failed/pending/completed`.
- `ErrorMessage`: A field added only in case of an error, recording the error message.

### Lambda Function
- Triggered by an S3 event.
- Inserts the original image information into DynamoDB.
- Converts the image into different resolutions and stores them in the S3 Bucket.
- Inserts the information of the original and resolution-specific converted images into DynamoDB.
- If conversion fails:
  - The Lambda function will attempt to retry twice.
  - If still unsuccessful, it will log the failure and error message in DynamoDB.
  - Issues with the original image will already have been validated by the GitHub Action, so no additional checks will be performed at this stage.

## Implementation
- TBD
